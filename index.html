<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Workout History</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.4;
            -webkit-text-size-adjust: 100%;
        }
        
        .container {
            padding: 12px;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            font-weight: 600;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 0.8rem;
        }
        
        h2 {
            font-size: 1.2rem;
            margin-bottom: 0.6rem;
        }
        
        h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        /* Card Components */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-bottom: 16px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0;
            font-size: 0.75rem;
            color: #666;
            font-weight: normal;
        }
        
        .stat-card p {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 4px 0 0;
        }
        
        .pushup-stats h2,
        .pushup-stats p {
            color: #4a90e2;
        }
        
        .pullup-stats h2,
        .pullup-stats p {
            color: #e24a4a;
        }
        
        /* Chart */
        .chart-container {
            position: relative;
            height: 200px; /* Smaller height for mobile */
            width: 100%;
            margin-top: 10px;
        }
        
        /* Tabs for time periods */
        .time-period {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }
        
        .time-period button {
            flex: 1;
            padding: 8px 4px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            background: #f5f7fa;
            color: #666;
        }
        
        .time-period button.active {
            background: #4a90e2;
            color: white;
        }
        
        /* Exercise toggle buttons */
        .exercise-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .exercise-toggle button {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        #pushupToggle {
            background-color: #4a90e2;
            color: white;
        }
        
        #pullupToggle {
            background-color: #e24a4a;
            color: white;
        }
        
        #pushupToggle.inactive, 
        #pullupToggle.inactive {
            background-color: #f5f7fa;
            color: #666;
            border: 1px solid #ddd;
        }
        
        /* Data section (hidden by default on mobile) */
        .data-input {
            display: none; /* Hidden by default on mobile */
        }
        
        .data-toggle {
            display: block;
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: #f5f7fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            color: #666;
        }
        
        /* Show data section when active */
        .data-input.active {
            display: block;
            margin-top: 12px;
        }
        
        textarea {
            width: 100%;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            box-sizing: border-box;
        }
        
        .button-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .button-row button {
            flex: 1;
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        /* Back button */
        .back-button {
            display: block;
            width: 100%;
            background: #f5f7fa;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            text-align: center;
            font-size: 0.9rem;
            text-decoration: none;
        }
        
        /* Debug panel */
        .debug-panel {
            padding: 10px;
            margin: 10px 0;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .debug-panel h3 {
            margin-top: 0;
        }
        
        .debug-panel button {
            margin-top: 10px;
            padding: 5px 10px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Workout History</h1>
            
            <div class="stats-grid">
                <div class="card pushup-stats">
                    <h2>Pushups</h2>
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3>Total</h3>
                            <p id="totalPushups">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Average</h3>
                            <p id="averagePushups">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Max</h3>
                            <p id="maxPushups">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Streak</h3>
                            <p id="currentPushupStreak">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="card pullup-stats">
                    <h2>Pullups</h2>
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3>Total</h3>
                            <p id="totalPullups">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Average</h3>
                            <p id="averagePullups">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Max</h3>
                            <p id="maxPullups">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Streak</h3>
                            <p id="currentPullupStreak">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="exercise-toggle">
                <button id="pushupToggle">Show Pushups</button>
                <button id="pullupToggle">Show Pullups</button>
            </div>
            
            <div class="time-period">
                <button class="period-btn active" data-period="week">Week</button>
                <button class="period-btn" data-period="month">Month</button>
                <button class="period-btn" data-period="year">Year</button>
                <button class="period-btn" data-period="all">All</button>
            </div>
            
            <div class="chart-container">
                <canvas id="exerciseChart"></canvas>
            </div>
            
            <button class="data-toggle" id="dataToggle">Advanced Options</button>
            
            <div class="data-input" id="dataInputSection">
                <textarea id="dataInput" placeholder='[
  {"date": "2023-01-01", "exercise": "pushup", "count": 30},
  {"date": "2023-01-01", "exercise": "pullup", "count": 10}
]'></textarea>
                
                <div class="button-row">
                    <button id="importBtn">Import Data</button>
                    <button id="fileInputBtn">Upload File</button>
                </div>
                
                <input type="file" id="fileInput" accept=".json,.csv" style="display:none;">
            </div>
        </div>
        
        <a href="javascript:history.back()" class="back-button">Back to Tracker</a>
    </div>
    
    <script>
        // Chart initialization
        let exerciseChart;
        let workoutData = [];
        let showPushups = true;
        let showPullups = true;
        
        // Sample data for initial display
        const sampleData = [
            { date: '2023-02-01', exercise: 'pushup', count: 30 },
            { date: '2023-02-01', exercise: 'pullup', count: 12 },
            { date: '2023-02-02', exercise: 'pushup', count: 35 },
            { date: '2023-02-02', exercise: 'pullup', count: 14 },
            { date: '2023-02-03', exercise: 'pushup', count: 40 },
            { date: '2023-02-03', exercise: 'pullup', count: 15 },
            { date: '2023-02-04', exercise: 'pushup', count: 45 },
            { date: '2023-02-04', exercise: 'pullup', count: 16 },
            { date: '2023-02-05', exercise: 'pushup', count: 50 },
            { date: '2023-02-05', exercise: 'pullup', count: 18 },
            { date: '2023-02-06', exercise: 'pushup', count: 55 },
            { date: '2023-02-06', exercise: 'pullup', count: 20 },
            { date: '2023-02-07', exercise: 'pushup', count: 60 },
            { date: '2023-02-07', exercise: 'pullup', count: 22 }
        ];
        
        // Initialize the chart
        function initChart() {
            const ctx = document.getElementById('exerciseChart').getContext('2d');
            
            // Set Chart.js default font
            Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, sans-serif';
            Chart.defaults.font.size = 10;
            
            exerciseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Pushups',
                            data: [],
                            backgroundColor: 'rgba(74, 144, 226, 0.2)',
                            borderColor: 'rgba(74, 144, 226, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(74, 144, 226, 1)',
                            pointBorderColor: '#fff',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            tension: 0.1,
                            order: 1
                        },
                        {
                            label: 'Pullups',
                            data: [],
                            backgroundColor: 'rgba(226, 74, 74, 0.2)',
                            borderColor: 'rgba(226, 74, 74, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(226, 74, 74, 1)',
                            pointBorderColor: '#fff',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            tension: 0.1,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                padding: 5
                            }
                        },
                        x: {
                            title: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                padding: 5,
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    const date = new Date(label);
                                    return (date.getMonth() + 1) + "/" + date.getDate();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            position: 'top',
                            labels: {
                                boxWidth: 10,
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return new Date(tooltipItems[0].label).toLocaleDateString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Check for data in localStorage
        function checkForLocalData() {
            console.log("Checking for local data...");
            const localData = localStorage.getItem('visualizationData');
            if (localData) {
                try {
                    const parsedData = JSON.parse(localData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        // We found valid data, use it
                        console.log("Found valid data:", parsedData.length, "entries");
                        workoutData = parsedData;
                        updateChart(getActivePeriod());
                        return true;
                    }
                } catch (e) {
                    console.error('Error parsing local data:', e);
                }
            }
            console.log("No valid visualization data found");
            return false;
        }
        
        // Debug Data Status - shows a debug panel with information about localStorage data
        function debugDataStatus() {
            console.log("Running data diagnostics...");
            
            // Create a debugging panel
            const debugPanel = document.createElement('div');
            debugPanel.className = 'debug-panel';
            
            // Check for visualizationData
            const visualizationData = localStorage.getItem('visualizationData');
            
            // Check for raw pushup and pullup logs
            const pushupLogs = localStorage.getItem('pushupLogs');
            const pullupLogs = localStorage.getItem('pullupLogs');
            
            // Build status report
            let statusHtml = '<h3>Debug Status</h3>';
            
            if (visualizationData) {
                try {
                    const parsedData = JSON.parse(visualizationData);
                    statusHtml += `<p>✅ VisualizationData found: ${parsedData.length} entries</p>`;
                    
                    // Add details about the data
                    const pushupCount = parsedData.filter(item => item.exercise === 'pushup').length;
                    const pullupCount = parsedData.filter(item => item.exercise === 'pullup').length;
                    
                    statusHtml += `<p>- Pushup entries: ${pushupCount}</p>`;
                    statusHtml += `<p>- Pullup entries: ${pullupCount}</p>`;
                    
                    // Show a few sample entries
                    if (parsedData.length > 0) {
                        statusHtml += '<p>Sample entry: ' + JSON.stringify(parsedData[0]) + '</p>';
                    }
                } catch (e) {
                    statusHtml += `<p>❌ Error parsing visualizationData: ${e.message}</p>`;
                }
            } else {
                statusHtml += '<p>❌ No visualizationData found in localStorage</p>';
            }
            
            // Check raw logs
            if (pushupLogs) {
                try {
                    const parsedPushups = JSON.parse(pushupLogs);
                    statusHtml += `<p>✅ Raw pushupLogs found: ${parsedPushups.length} entries</p>`;
                    
                    // Add sample entry
                    if (parsedPushups.length > 0) {
                        statusHtml += '<p>Sample pushup: ' + JSON.stringify(parsedPushups[0]) + '</p>';
                    }
                } catch (e) {
                    statusHtml += `<p>❌ Error parsing pushupLogs: ${e.message}</p>`;
                }
            } else {
                statusHtml += '<p>❌ No pushupLogs found in localStorage</p>';
            }
            
            if (pullupLogs) {
                try {
                    const parsedPullups = JSON.parse(pullupLogs);
                    statusHtml += `<p>✅ Raw pullupLogs found: ${parsedPullups.length} entries</p>`;
                } catch (e) {
                    statusHtml += `<p>❌ Error parsing pullupLogs: ${e.message}</p>`;
                }
            } else {
                statusHtml += '<p>❌ No pullupLogs found in localStorage</p>';
            }
            
            // Add button to fix data manually if needed
            statusHtml += '<button id="fixDataBtn">Fix Data Format</button>';
            
            debugPanel.innerHTML = statusHtml;
            
            // Insert debug panel into the page
            const container = document.querySelector('.container');
            container.appendChild(debugPanel);
            
            // Add event listener to fix data button
            document.getElementById('fixDataBtn').addEventListener('click', function() {
                // Try to format data properly from raw logs
                if (pushupLogs || pullupLogs) {
                    try {
                        const parsedPushups = pushupLogs ? JSON.parse(pushupLogs) : [];
                        const parsedPullups = pullupLogs ? JSON.parse(pullupLogs) : [];
                        
                        const formattedPushups = parsedPushups.map(log => ({
                            date: new Date(log.date).toISOString().split('T')[0],
                            exercise: 'pushup',
                            count: log.count
                        }));
                        
                        const formattedPullups = parsedPullups.map(log => ({
                            date: new Date(log.date).toISOString().split('T')[0],
                            exercise: 'pullup',
                            count: log.count
                        }));
                        
                        const formattedData = [...formattedPushups, ...formattedPullups];
                        
                        // Store the formatted data
                        localStorage.setItem('visualizationData', JSON.stringify(formattedData));
                        
                        // Update the display
                        workoutData = formattedData;
                        updateChart(getActivePeriod());
                        
                        alert('Data format fixed! Found and formatted ' + formattedData.length + ' workout entries.');
                        
                        // Refresh debug panel
                        debugDataStatus();
                    } catch (e) {
                        alert('Error fixing data: ' + e.message);
                    }
                } else {
                    alert('No raw logs found to fix the data format.');
                }
            });
        }
        
        // Update chart with new data based on time period
        function updateChart(period = 'week') {
            console.log("Updating chart with period:", period);
            if (!workoutData.length) {
                console.log("No workout data to display");
                return;
            }
            
            // Get pushup and pullup data
            const pushupData = workoutData.filter(item => item.exercise === 'pushup');
            const pullupData = workoutData.filter(item => item.exercise === 'pullup');
            
            console.log("Filtered data - pushups:", pushupData.length, "pullups:", pullupData.length);
            
            // Sort data by date
            const sortedPushupData = [...pushupData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const sortedPullupData = [...pullupData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Get earliest and latest dates from either dataset
            const allDates = [...new Set([...pushupData.map(item => item.date), ...pullupData.map(item => item.date)])];
            const sortedDates = allDates.sort((a, b) => new Date(a) - new Date(b));
            
            if (sortedDates.length === 0) {
                console.log("No dates found after filtering");
                return;
            }
            
            // Filter data based on selected time period
            let filteredDates = sortedDates;
            const now = new Date();
            
            if (period === 'week') {
                const oneWeekAgo = new Date(now);
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                filteredDates = sortedDates.filter(date => new Date(date) >= oneWeekAgo);
            } else if (period === 'month') {
                const oneMonthAgo = new Date(now);
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                filteredDates = sortedDates.filter(date => new Date(date) >= oneMonthAgo);
            } else if (period === 'year') {
                const oneYearAgo = new Date(now);
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                filteredDates = sortedDates.filter(date => new Date(date) >= oneYearAgo);
            }
            
            console.log("Filtered dates for period:", filteredDates.length);
            
            if (filteredDates.length === 0) {
                // If no dates in the filtered range, show empty chart
                exerciseChart.data.labels = [];
                exerciseChart.data.datasets[0].data = [];
                exerciseChart.data.datasets[1].data = [];
                exerciseChart.update();
                console.log("No dates in filtered range, showing empty chart");
                return;
            }
            
            // Fill in all dates in the range
            const startDate = new Date(filteredDates[0]);
            const endDate = new Date(filteredDates[filteredDates.length - 1]);
            const dateRange = [];
            
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateRange.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log("Date range:", dateRange.length, "days");
            
            // Create maps for quick lookup
            const pushupMap = new Map();
            sortedPushupData.forEach(item => {
                pushupMap.set(item.date, item.count);
            });
            
            const pullupMap = new Map();
            sortedPullupData.forEach(item => {
                pullupMap.set(item.date, item.count);
            });
            
            // Create datasets with all dates filled in
            const pushupDataset = dateRange.map(date => ({
                x: date,
                y: pushupMap.has(date) ? pushupMap.get(date) : 0
            }));
            
            const pullupDataset = dateRange.map(date => ({
                x: date,
                y: pullupMap.has(date) ? pullupMap.get(date) : 0
            }));
            
            // Update chart visibility based on toggle state
            exerciseChart.data.datasets[0].hidden = !showPushups;
            exerciseChart.data.datasets[1].hidden = !showPullups;
            
            // Update chart data
            exerciseChart.data.labels = dateRange;
            exerciseChart.data.datasets[0].data = pushupDataset;
            exerciseChart.data.datasets[1].data = pullupDataset;
            exerciseChart.update();
            
            console.log("Chart updated with", dateRange.length, "data points");
            
            // Update stats
            updatePushupStats(sortedPushupData);
            updatePullupStats(sortedPullupData);
        }
        
        // Update pushup stats
        function updatePushupStats(data) {
            // Calculate total pushups
            const totalPushups = data.reduce((sum, item) => sum + item.count, 0);
            document.getElementById('totalPushups').textContent = totalPushups;
            
            // Calculate average pushups per day with activity
            const daysWithActivity = data.filter(item => item.count > 0).length;
            const avgPushups = daysWithActivity ? Math.round(totalPushups / daysWithActivity) : 0;
            document.getElementById('averagePushups').textContent = avgPushups;
            
            // Find max pushups in one day
            const maxPushups = data.length ? Math.max(...data.map(item => item.count)) : 0;
            document.getElementById('maxPushups').textContent = maxPushups;
            
            // Calculate current streak
            const streak = calculateStreak(data);
            document.getElementById('currentPushupStreak').textContent = streak;
        }
        
        // Update pullup stats
        function updatePullupStats(data) {
            // Calculate total pullups
            const totalPullups = data.reduce((sum, item) => sum + item.count, 0);
            document.getElementById('totalPullups').textContent = totalPullups;
            
            // Calculate average pullups per day with activity
            const daysWithActivity = data.filter(item => item.count > 0).length;
            const avgPullups = daysWithActivity ? Math.round(totalPullups / daysWithActivity) : 0;
            document.getElementById('averagePullups').textContent = avgPullups;
            
            // Find max pullups in one day
            const maxPullups = data.length ? Math.max(...data.map(item => item.count)) : 0;
            document.getElementById('maxPullups').textContent = maxPullups;
            
            // Calculate current streak
            const streak = calculateStreak(data);
            document.getElementById('currentPullupStreak').textContent = streak;
        }
        
        // Calculate streak for a given exercise
        function calculateStreak(data) {
            if (!data.length) return 0;
            
            let currentStreak = 0;
            
            // Sort by date descending to check recent dates first
            const sortedDatesDesc = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            const todayEntry = sortedDatesDesc.find(item => item.date === today);
            
            if (todayEntry && todayEntry.count > 0) {
                // If there's an entry for today with activity, start counting streak
                currentStreak = 1;
                
                // Check previous days
                let prevDate = new Date(today);
                while (true) {
                    prevDate.setDate(prevDate.getDate() - 1);
                    const prevDateStr = prevDate.toISOString().split('T')[0];
                    const entry = sortedDatesDesc.find(item => item.date === prevDateStr);
                    
                    if (entry && entry.count > 0) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            } else {
                // Check if there was activity yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                const yesterdayEntry = sortedDatesDesc.find(item => item.date === yesterdayStr);
                
                if (yesterdayEntry && yesterdayEntry.count > 0) {
                    currentStreak = 1;
                    
                    // Check previous days
                    let prevDate = new Date(yesterdayStr);
                    while (true) {
                        prevDate.setDate(prevDate.getDate() - 1);
                        const prevDateStr = prevDate.toISOString().split('T')[0];
                        const entry = sortedDatesDesc.find(item => item.date === prevDateStr);
                        
                        if (entry && entry.count > 0) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }
                }
            }
            
            return currentStreak;
        }
        
        // Fixed toggle function for exercise visibility
        function toggleExerciseVisibility(exercise) {
            console.log('Toggle clicked for:', exercise);
            
            if (exercise === 'pushup') {
                showPushups = !showPushups;
                const btn = document.getElementById('pushupToggle');
                if (showPushups) {
                    btn.classList.remove('inactive');
                    btn.style.backgroundColor = '#4a90e2';
                    btn.style.color = 'white';
                } else {
                    btn.classList.add('inactive');
                    btn.style.backgroundColor = '#f5f7fa';
                    btn.style.color = '#666';
                }
            } else if (exercise === 'pullup') {
                showPullups = !showPullups;
                const btn = document.getElementById('pullupToggle');
                if (showPullups) {
                    btn.classList.remove('inactive');
                    btn.style.backgroundColor = '#e24a4a';
                    btn.style.color = 'white';
                } else {
                    btn.classList.add('inactive');
                    btn.style.backgroundColor = '#f5f7fa';
                    btn.style.color = '#666';
                }
            }
            
            // Force update the chart
            if (exerciseChart) {
                exerciseChart.data.datasets[0].hidden = !showPushups;
                exerciseChart.data.datasets[1].hidden = !showPullups;
                exerciseChart.update();
                console.log('Chart updated: pushups=' + showPushups + ', pullups=' + showPullups);
            } else {
                console.log('Chart not initialized yet');
            }
        }
        
        // Parse JSON data
        function parseJsonData(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                
                if (!Array.isArray(data)) {
                    throw new Error('Data must be an array');
                }
                
                // Validate each entry
                const validData = data.filter(item => {
                    return item && typeof item === 'object' && 
                           item.date && typeof item.date === 'string' &&
                           !isNaN(new Date(item.date).getTime()) &&
                           'count' in item && !isNaN(parseInt(item.count)) &&
                           item.exercise && typeof item.exercise === 'string' &&
                           (item.exercise.toLowerCase() === 'pushup' || 
                            item.exercise.toLowerCase() === 'pullup');
                }).map(item => ({
                    date: new Date(item.date).toISOString().split('T')[0],
                    exercise: item.exercise.toLowerCase(),
                    count: parseInt(item.count)
                }));
                
                if (validData.length === 0) {
                    throw new Error('No valid data entries found');
                }
                
                return validData;
            } catch (error) {
                alert('Error parsing data: ' + error.message);
                return null;
            }
        }
        
        // Parse CSV data
        function parseCsvData(csvString) {
            try {
                const lines = csvString.split(/\r?\n/);
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                const dateIndex = headers.findIndex(h => h.includes('date'));
                const exerciseIndex = headers.findIndex(h => 
                    h.includes('exercise') || 
                    h.includes('type') || 
                    h.includes('workout')
                );
                const countIndex = headers.findIndex(h => 
                    h.includes('count') || 
                    h.includes('reps') || 
                    h.includes('number')
                );
                
                if (dateIndex === -1 || countIndex === -1) {
                    throw new Error('CSV must contain date and count columns');
                }
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',');
                    const dateStr = values[dateIndex].trim();
                    const countStr = values[countIndex].trim();
                    
                    // If no exercise column, try to detect from other columns or default to pushup
                    let exercise = 'pushup';
                    if (exerciseIndex !== -1) {
                        const exerciseValue = values[exerciseIndex].trim().toLowerCase();
                        if (exerciseValue.includes('pull')) {
                            exercise = 'pullup';
                        } else if (exerciseValue.includes('push')) {
                            exercise = 'pushup';
                        }
                    }
                    
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) continue;
                    
                    const count = parseInt(countStr);
                    if (isNaN(count)) continue;
                    
                    data.push({
                        date: date.toISOString().split('T')[0],
                        exercise: exercise,
                        count: count
                    });
                }
                
                if (data.length === 0) {
                    throw new Error('No valid data entries found in CSV');
                }
                
                return data;
            } catch (error) {
                alert('Error parsing CSV: ' + error.message);
                return null;
            }
        }
        
        // Handle file upload
        function handleFileUpload(file) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const content = event.target.result;
                
                if (file.name.endsWith('.json')) {
                    const data = parseJsonData(content);
                    if (data) {
                        workoutData = data;
                        updateChart(getActivePeriod());
                        localStorage.setItem('visualizationData', JSON.stringify(data));
                    }
                } else if (file.name.endsWith('.csv')) {
                    const data = parseCsvData(content);
                    if (data) {
                        workoutData = data;
                        updateChart(getActivePeriod());
                        localStorage.setItem('visualizationData', JSON.stringify(data));
                    }
                } else {
                    alert('Unsupported file type. Please upload a JSON or CSV file.');
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file');
            };
            
            if (file.name.endsWith('.json') || file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                alert('Unsupported file type. Please upload a JSON or CSV file.');
            }
        }
        
        // Get active time period
        function getActivePeriod() {
            const activeBtn = document.querySelector('.period-btn.active');
            return activeBtn ? activeBtn.dataset.period : 'week';
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded, initializing...");
            
            // Initialize chart
            initChart();
            
            // First check for local data
            const foundLocalData = checkForLocalData();
            
            // Add debug panel
            debugDataStatus();
            
            // If no local data was found, load sample data
            if (!foundLocalData) {
                console.log("Loading sample data instead");
                workoutData = sampleData;
                updateChart('week');
            }
            
            // Time period selection
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('Period button clicked:', this.dataset.period);
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateChart(this.dataset.period);
                });
            });
            
            // Exercise toggle
            document.getElementById('pushupToggle').addEventListener('click', function() {
                console.log('Pushup toggle clicked');
                toggleExerciseVisibility('pushup');
            });
            
            document.getElementById('pullupToggle').addEventListener('click', function() {
                console.log('Pullup toggle clicked');
                toggleExerciseVisibility('pullup');
            });
            
            // Toggle data input section
            document.getElementById('dataToggle').addEventListener('click', function() {
                const dataSection = document.getElementById('dataInputSection');
                dataSection.classList.toggle('active');
                this.textContent = dataSection.classList.contains('active') ? 'Hide Advanced Options' : 'Advanced Options';
            });
            
            // Import button
            document.getElementById('importBtn').addEventListener('click', function() {
                const inputData = document.getElementById('dataInput').value.trim();
                if (inputData) {
                    const data = parseJsonData(inputData);
                    if (data) {
                        workoutData = data;
                        updateChart(getActivePeriod());
                        localStorage.setItem('visualizationData', JSON.stringify(data));
                    }
                } else {
                    alert('Please enter some data to import');
                }
            });
            
            // File input button
            document.getElementById('fileInputBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            // File input change
            document.getElementById('fileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });
            
            console.log("Initialization complete");
        });
    </script>
</body>
</html>
